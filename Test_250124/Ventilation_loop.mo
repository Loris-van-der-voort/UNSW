within Test_250124;
model Ventilation_loop
    package MediumA = .Buildings.Media.Air "Medium model";
    package MediumW = .Buildings.Media.Water "Medium model";
    parameter Modelica.Units.SI.Volume VRoo1=100 "Room 1 volume";
    parameter Modelica.Units.SI.MassFlowRate m_flow_nom_heater=0.01;
    parameter Modelica.Units.SI.MassFlowRate m_flow_nom_cooler=0.01;   
    parameter Modelica.Units.SI.MassFlowRate m_flow_nom_air=0.018;     
    .Buildings.ThermalZones.EnergyPlus_9_6_0.ThermalZone zon(nPorts = 2,redeclare replaceable package Medium = MediumA,zoneName = "GroundFloorQ1:GX112XLunchroom") annotation(Placement(transformation(extent = {{47.477471106571656,29.477471106571656},{72.52252889342834,54.522528893428344}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.Sources.Boundary_pT HWsource(nPorts = 1,redeclare replaceable package Medium = MediumW,T = 273.15 + 60) annotation(Placement(transformation(extent = {{-10.0,-10.0},{10.0,10.0}},origin = {-76.0,-80.0},rotation = 90.0)));
    .Buildings.Fluid.Sources.Boundary_pT HWsink(nPorts = 1,redeclare replaceable package Medium = MediumW) annotation(Placement(transformation(extent = {{-10.0,-10.0},{10.0,10.0}},origin = {-36.0,-81.19999999999999},rotation = 90.0)));
    .Buildings.Experimental.DHC.EnergyTransferStations.BaseClasses.Pump_m_flow pump_m_flow(redeclare replaceable package Medium = MediumW,m_flow_nominal = 0.1) annotation(Placement(transformation(extent = {{-6.55975223852235,-6.55975223852235},{6.55975223852235,6.55975223852235}},origin = {-76.0,-40.0},rotation = 90.0)));
    .Buildings.Fluid.Sources.Boundary_pT CWsource(nPorts = 1,redeclare replaceable package Medium = MediumW,T = 273.15 + 6) annotation(Placement(transformation(extent = {{-10.0,-10.0},{10.0,10.0}},origin = {-2.666666666666666,-82.0},rotation = 90.0)));
    .Buildings.Experimental.DHC.EnergyTransferStations.BaseClasses.Pump_m_flow pump_m_flow2(redeclare replaceable package Medium = MediumW,m_flow_nominal = 0.1) annotation(Placement(transformation(extent = {{-6.55975223852235,-6.55975223852235},{6.55975223852235,6.55975223852235}},origin = {-2.666666666666666,-40.00000000000001},rotation = 90.0)));
    .Buildings.Fluid.Sources.Boundary_pT CWsink(nPorts = 1,redeclare replaceable package Medium = MediumW) annotation(Placement(transformation(extent = {{-10.0,-10.0},{10.0,10.0}},origin = {38.0,-82.0},rotation = 90.0)));
    .Buildings.Fluid.Sources.Boundary_pT Airsink(nPorts = 1,redeclare replaceable package Medium = MediumA) annotation(Placement(transformation(extent = {{-182.0,8.0},{-162.0,28.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Experimental.DHC.EnergyTransferStations.BaseClasses.Pump_m_flow pump_m_flow3(redeclare replaceable package Medium = MediumA,m_flow_nominal = m_flow_nom_air) annotation(Placement(transformation(extent = {{-150.55975223852235,-18.55975223852235},{-137.44024776147765,-5.44024776147765}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Controls.OBC.CDL.Continuous.Sources.Constant con(k = 0) annotation(Placement(transformation(extent = {{19.20093345755824,49.20093345755824},{28.79906654244176,58.79906654244176}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Controls.OBC.CDL.Continuous.Sources.Constant con2(k = 0.018) annotation(Placement(transformation(extent = {{-155.59797292490921,2.4020270750907997},{-148.40202707509079,9.5979729249092}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Controls.OBC.CDL.Continuous.Sources.Constant con3(k = 0.01) annotation(Placement(transformation(extent = {{-103.59797292490921,-43.5979729249092},{-96.40202707509079,-36.4020270750908}},origin = {0.0,0.0},rotation = 0.0)));
    inner .Buildings.ThermalZones.EnergyPlus_9_6_0.Building building(idfName = Modelica.Utilities.Files.loadResource("modelica://Test_250124/Resources/CSIRO_B7_V6.idf"),epwName = Modelica.Utilities.Files.loadResource("modelica://Test_250124/Resources/AUS_ACT_Canberra.Intl.AP.949260_TMYx.2007-2021.epw"),weaName = Modelica.Utilities.Files.loadResource("modelica://Test_250124/Resources/AUS_ACT_Canberra.Intl.AP.949260_TMYx.2007-2021.mos")) annotation(Placement(transformation(extent = {{-216.0,-14.0},{-196.0,6.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.HeatExchangers.DryCoilCounterFlow HeatRecovery(redeclare replaceable package Medium1 = MediumA,redeclare replaceable package Medium2 = MediumA,m1_flow_nominal = m_flow_nom_air,m2_flow_nominal = m_flow_nom_air,redeclare replaceable model HexElement = .Buildings.Fluid.HeatExchangers.BaseClasses.HexElementSensible,UA_nominal = m_flow_nom_air * 1006 * 5) annotation(Placement(transformation(extent = {{-85.33400029689733,2.0},{-106.66599970310267,22.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.HeatExchangers.DryCoilCounterFlow Heater(redeclare replaceable package Medium1 = MediumA,redeclare replaceable package Medium2 = MediumW,m1_flow_nominal = m_flow_nom_air,m2_flow_nominal = m_flow_nom_heater,UA_nominal = m_flow_nom_air * 1006 * 5) annotation(Placement(transformation(extent = {{-49.33400029689733,-10.0},{-70.66599970310267,10.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.HeatExchangers.DryCoilCounterFlow Cooler(redeclare replaceable package Medium1 = MediumA,redeclare replaceable package Medium2 = MediumW,m1_flow_nominal = m_flow_nom_air,m2_flow_nominal = m_flow_nom_cooler,UA_nominal = m_flow_nom_air * 1006 * 5) annotation(Placement(transformation(extent = {{26.66599970310267,-10.0},{5.3340002968973295,10.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.Sources.Outside outdoorAir(nPorts = 1,redeclare replaceable package Medium = MediumA) annotation(Placement(transformation(extent = {{-182.0,-22.0},{-162.0,-2.0}},origin = {0.0,0.0},rotation = 0.0)));
    .Buildings.Fluid.HeatExchangers.DryCoilEffectivenessNTU hex(use_Q_flow_nominal = false) annotation(Placement(transformation(extent = {{-82,52},{-62,72}},origin = {0,0},rotation = 0)));
equation
    connect(HWsource.ports[1],pump_m_flow.port_a) annotation(Line(points = {{-76,-70},{-76,-46.55975223852235}},color = {0,127,255}));
    connect(CWsource.ports[1],pump_m_flow2.port_a) annotation(Line(points = {{-2.6666666666666643,-72},{-2.6666666666666643,-46.55975223852236}},color = {0,127,255}));
    connect(con.y,zon.qGai_flow[1]) annotation(Line(points = {{29.758879850930114,54},{40,54},{40,48.26126444671417},{46.22521821722882,48.26126444671417}},color = {0,0,127}));
    connect(con.y,zon.qGai_flow[2]) annotation(Line(points = {{29.758879850930114,54},{40.22521821722882,54},{40.22521821722882,48.26126444671417},{46.22521821722882,48.26126444671417}},color = {0,0,127}));
    connect(con.y,zon.qGai_flow[3]) annotation(Line(points = {{29.758879850930114,54},{40.22521821722882,54},{40.22521821722882,48.26126444671417},{46.22521821722882,48.26126444671417}},color = {0,0,127}));
    connect(con2.y,pump_m_flow3.m_flow_in) annotation(Line(points = {{-147.68243249010894,6},{-144,6},{-144,-4.128297313773181}},color = {0,0,127}));
    connect(con3.y,pump_m_flow.m_flow_in) annotation(Line(points = {{-95.68243249010894,-40},{-83.87170268622683,-40}},color = {0,0,127}));
    connect(con3.y,pump_m_flow2.m_flow_in) annotation(Line(points = {{-95.68243249010894,-40},{-95.68243249010894,-56},{-10.53836935289349,-56},{-10.53836935289349,-40.00000000000001}},color = {0,0,127}));
    connect(HeatRecovery.port_a2,pump_m_flow3.port_b) annotation(Line(points = {{-106.66599970310267,6},{-122.05312373229016,6},{-122.05312373229016,-12},{-137.44024776147765,-12}},color = {0,127,255}));
    connect(Airsink.ports[1],HeatRecovery.port_b1) annotation(Line(points = {{-162,18},{-106.66599970310267,18}},color = {0,127,255}));
    connect(HeatRecovery.port_b2,Heater.port_b1) annotation(Line(points = {{-85.33400029689733,6},{-70.66599970310267,6}},color = {0,127,255}));
    connect(Heater.port_b2,HWsink.ports[1]) annotation(Line(points = {{-49.33400029689733,-6},{-36,-6},{-36,-71.19999999999999}},color = {0,127,255}));
    connect(Heater.port_a2,pump_m_flow.port_b) annotation(Line(points = {{-70.66599970310267,-6},{-76,-6},{-76,-33.44024776147765}},color = {0,127,255}));
    connect(Heater.port_a1,Cooler.port_b1) annotation(Line(points = {{-49.33400029689733,6},{5.3340002968973295,6}},color = {0,127,255}));
    connect(pump_m_flow2.port_b,Cooler.port_a2) annotation(Line(points = {{-2.6666666666666647,-33.44024776147766},{-2.6666666666666647,-6},{5.3340002968973295,-6}},color = {0,127,255}));
    connect(Cooler.port_b2,CWsink.ports[1]) annotation(Line(points = {{26.66599970310267,-6},{38,-6},{38,-72}},color = {0,127,255}));
    connect(Cooler.port_a1,zon.ports[1]) annotation(Line(points = {{26.66599970310267,6},{60,6},{60,30.040984906775932}},color = {0,127,255}));
    connect(zon.ports[2],HeatRecovery.port_a1) annotation(Line(points = {{60,30.040984906775932},{60,18},{-85.33400029689733,18}},color = {0,127,255}));
    connect(outdoorAir.ports[1],pump_m_flow3.port_a) annotation(Line(points = {{-162,-12},{-150.55975223852235,-12}},color = {0,127,255}));
    connect(building.weaBus,outdoorAir.weaBus) annotation(Line(points = {{-196,-4},{-189,-4},{-189,-11.8},{-182,-11.8}},color = {255,204,51}));
    annotation(Icon(coordinateSystem(preserveAspectRatio = false,extent = {{-100.0,-100.0},{100.0,100.0}}),graphics = {Rectangle(lineColor={0,0,0},fillColor={230,230,230},fillPattern=FillPattern.Solid,extent={{-100.0,-100.0},{100.0,100.0}}),Text(lineColor={0,0,255},extent={{-150,150},{150,110}},textString="%name")}));
end Ventilation_loop;
